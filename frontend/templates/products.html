{% extends "base.html" %}

{% block title %}Productos - Sistema de Inventario{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Gestión de Productos</h2>
</div>

<div class="form-section">
    <h3 id="form-title">Crear Nuevo Producto</h3>
    <form id="product-form">
        <input type="hidden" id="product-id">
        <div class="form-row">
            <div class="form-group">
                <label for="product-name">Nombre:</label>
                <input type="text" id="product-name" required>
            </div>
            <div class="form-group">
                <label for="product-category">Categoría:</label>
                <select id="product-category" required>
                    <option value="">Seleccione una categoría</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="product-price">Precio:</label>
                <input type="number" id="product-price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="product-stock">Stock:</label>
                <input type="number" id="product-stock" min="0" required>
            </div>
        </div>
        <div class="form-group">
            <label for="product-description">Descripción:</label>
            <textarea id="product-description" rows="3"></textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">Crear Producto</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;">Cancelar</button>
        </div>
    </form>
</div>

<div class="table-section">
    <h3>Listado de Productos</h3>
    <div id="message" class="message" style="display: none;"></div>
    <table id="products-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Descripción</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="products-list">
            <tr><td colspan="7" class="loading">Cargando...</td></tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
    let editingId = null;
    let categories = [];

    async function loadCategories() {
        try {
            const response = await fetch(`${API_URL}/api/categories`);
            categories = await response.json();

            const select = document.getElementById('product-category');
            select.innerHTML = '<option value="">Seleccione una categoría</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        } catch (error) {
            showMessage('Error al cargar categorías: ' + error.message, 'error');
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch(`${API_URL}/api/products`);
            const products = await response.json();

            const tbody = document.getElementById('products-list');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">No hay productos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(prod => `
                <tr>
                    <td>${prod.id}</td>
                    <td>${prod.name}</td>
                    <td>${prod.category_name || 'N/A'}</td>
                    <td>$${prod.price.toFixed(2)}</td>
                    <td>${prod.stock}</td>
                    <td>${prod.description || '-'}</td>
                    <td>
                        <button onclick="editProduct(${prod.id})" class="btn btn-small btn-edit">Editar</button>
                        <button onclick="deleteProduct(${prod.id})" class="btn btn-small btn-delete">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            showMessage('Error al cargar productos: ' + error.message, 'error');
        }
    }

    async function editProduct(id) {
        try {
            const response = await fetch(`${API_URL}/api/products/${id}`);
            const product = await response.json();

            editingId = id;
            document.getElementById('product-id').value = id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.category_id;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-description').value = product.description || '';

            document.getElementById('form-title').textContent = 'Editar Producto';
            document.getElementById('submit-btn').textContent = 'Actualizar Producto';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        } catch (error) {
            showMessage('Error al cargar producto: ' + error.message, 'error');
        }
    }

    function cancelEdit() {
        editingId = null;
        document.getElementById('product-form').reset();
        document.getElementById('form-title').textContent = 'Crear Nuevo Producto';
        document.getElementById('submit-btn').textContent = 'Crear Producto';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    async function deleteProduct(id) {
        if (!confirm('¿Está seguro de eliminar este producto?')) return;

        try {
            const response = await fetch(`${API_URL}/api/products/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showMessage('Producto eliminado exitosamente', 'success');
                loadProducts();
            } else {
                const error = await response.json();
                showMessage('Error: ' + error.error, 'error');
            }
        } catch (error) {
            showMessage('Error al eliminar: ' + error.message, 'error');
        }
    }

    document.getElementById('product-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            name: document.getElementById('product-name').value,
            category_id: parseInt(document.getElementById('product-category').value),
            price: parseFloat(document.getElementById('product-price').value),
            stock: parseInt(document.getElementById('product-stock').value),
            description: document.getElementById('product-description').value
        };

        const url = editingId
            ? `${API_URL}/api/products/${editingId}`
            : `${API_URL}/api/products`;
        const method = editingId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showMessage(`Producto ${editingId ? 'actualizado' : 'creado'} exitosamente`, 'success');
                document.getElementById('product-form').reset();
                cancelEdit();
                loadProducts();
            } else {
                const error = await response.json();
                showMessage('Error: ' + error.error, 'error');
            }
        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
        }
    });

    document.getElementById('cancel-btn').addEventListener('click', cancelEdit);

    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadProducts();
    });
</script>
{% endblock %}